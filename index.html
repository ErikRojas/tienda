<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS Loyverse Pro</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background:#f4f7f6; padding:20px; color: #333; }
        .container { display:flex; gap:20px; max-width:1400px; margin:auto; }
        .products { flex:3; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .cart { flex:1; background:#fff; padding:20px; border-radius:8px; box-shadow:0 4px 15px rgba(0,0,0,.1); position:sticky; top:20px; align-self:flex-start; }
        input { width:100%; padding:10px; margin:8px 0; border:1px solid #ccc; border-radius:4px; box-sizing: border-box; }
        button { width:100%; padding:12px; margin:6px 0; font-size:16px; border:none; border-radius:4px; cursor:pointer; font-weight: bold; }
        .btn-add { background:#4CAF50; color:#fff; }
        .btn-add:disabled { background:#ccc; cursor:not-allowed; }
        table { width:100%; border-collapse:collapse; }
        th, td { border-bottom:1px solid #eee; padding:10px; text-align: left; }
        th { background:#f8f9fa; font-size: 12px; color: #777; }
        .total { font-size:1.8em; font-weight:bold; color:#d32f2f; text-align:right; margin: 15px 0; }
        .status-bar { background: #2c3e50; color: white; padding: 10px; border-radius: 4px; margin-bottom: 20px; text-align: center; }
        .success { color: #2ecc71; }
        .error { color: #e74c3c; }
    </style>
</head>
<body>

<div id="statusMessage" class="status-bar">Sincronizando con Loyverse...</div>

<div class="container">
    <div class="products">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2>Inventario Real</h2>
            <button onclick="loadItems()" style="width: auto; background: #3498db; color: white; padding: 5px 15px;">üîÑ Actualizar Stock</button>
        </div>
        <div style="display: flex; gap: 10px;">
            <input id="barcodeInput" placeholder="Escaneo r√°pido de c√≥digo..." autofocus>
            <input id="searchInput" placeholder="Buscar producto o categor√≠a..." oninput="filterItems()">
        </div>

        <table>
            <thead>
                <tr>
                    <th>Producto</th>
                    <th>Categor√≠a</th>
                    <th>C√≥digo</th>
                    <th>Stock</th>
                    <th>Precio</th>
                    <th>Acci√≥n</th>
                </tr>
            </thead>
            <tbody id="productsBody"></tbody>
        </table>
    </div>

    <div class="cart">
        <h2>Carrito</h2>
        <table id="cartTable">
            <thead>
                <tr><th>Item</th><th>Cant</th><th>Sub</th><th></th></tr>
            </thead>
            <tbody id="cartBody"></tbody>
        </table>

        <div class="total" id="totalLabel">0.00 BOB</div>

        <label>Monto Recibido</label>
        <input type="number" id="paymentAmount" step="0.5" placeholder="0.00" oninput="updateChange()">
        <div id="changeMessage" style="margin-bottom: 10px; font-weight: bold;"></div>

        <button onclick="registerSale()" style="background: #27ae60; color: white;">FINALIZAR VENTA</button>
        <button onclick="clearCart()" style="background:#e74c3c; color: white; font-size: 12px;">Vaciar Carrito</button>
    </div>
</div>

<audio id="beep"><source src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>

<script>
const workerUrl = 'https://loyverse-proxy-erik.erikrojas76.workers.dev';
let items = [];
let cart = [];

/* --- CARGA DE DATOS --- */
async function loadInventory() {
    let inventory = {};
    // Intentamos cargar inventario sin filtros para obtener todo lo disponible
    let url = '/v1.0/inventory?limit=250';
    try {
        while (url) {
            const res = await fetch(workerUrl + url);
            const data = await res.json();
            if (data.inventory) {
                data.inventory.forEach(i => {
                    // Sumamos stock si la variante aparece en m√∫ltiples tiendas
                    inventory[i.variant_id] = (inventory[i.variant_id] || 0) + (i.in_stock || 0);
                });
            }
            url = data.cursor ? `/v1.0/inventory?limit=250&cursor=${data.cursor}` : null;
        }
    } catch(e) { console.error("Error en Stock:", e); }
    return inventory;
}

async function loadCategories() {
    let categories = {};
    let url = '/v1.0/categories?limit=250';
    try {
        while (url) {
            const res = await fetch(workerUrl + url);
            const data = await res.json();
            if (data.categories) {
                data.categories.forEach(c => categories[c.id] = c.name);
            }
            url = data.cursor ? `/v1.0/categories?limit=250&cursor=${data.cursor}` : null;
        }
    } catch(e) { console.error("Error en Categor√≠as:", e); }
    return categories;
}

async function loadItems() {
    const status = document.getElementById('statusMessage');
    status.innerHTML = '‚è≥ Conectando con Loyverse...';
    
    try {
        const [inventory, categories] = await Promise.all([loadInventory(), loadCategories()]);
        items = [];
        let url = '/v1.0/items?limit=250';

        while (url) {
            const res = await fetch(workerUrl + url);
            const data = await res.json();
            if (data.items) {
                data.items.forEach(item => {
                    item.variants.forEach(v => {
                        v.stores.forEach(s => {
                            if (s.available_for_sale) {
                                items.push({
                                    name: v.variant_name !== 'Default' ? `${item.item_name} (${v.variant_name})` : item.item_name,
                                    category: categories[item.category_id] || 'General',
                                    barcode: v.barcode || '',
                                    variantId: v.variant_id,
                                    price: s.price || 0,
                                    stock: inventory[v.variant_id] ?? 0
                                });
                            }
                        });
                    });
                });
            }
            url = data.cursor ? `/v1.0/items?limit=250&cursor=${data.cursor}` : null;
        }
        renderProducts(items);
        status.innerHTML = `‚úÖ <span class="success">${items.length} Productos sincronizados</span>`;
    } catch (e) {
        status.innerHTML = `<span class="error">‚ùå Error de conexi√≥n. Revisa el Proxy.</span>`;
    }
}

/* --- L√ìGICA DE CARRITO --- */
function renderProducts(list) {
    const tb = document.getElementById('productsBody');
    tb.innerHTML = '';
    list.forEach(i => {
        const out = i.stock <= 0;
        const r = document.createElement('tr');
        r.innerHTML = `
            <td>${i.name}</td>
            <td>${i.category}</td>
            <td><small>${i.barcode}</small></td>
            <td style="color:${out?'red':'green'}"><b>${i.stock}</b></td>
            <td>${i.price.toFixed(2)}</td>
            <td><button class="btn-add" ${out?'disabled':''} onclick="addToCartByVId('${i.variantId}')">${out?'S/S':'+'}</button></td>
        `;
        tb.appendChild(r);
    });
}

function addToCartByVId(vId) {
    const item = items.find(x => x.variantId === vId);
    if (!item || item.stock <= 0) return;
    document.getElementById('beep').play();
    const ex = cart.find(c => c.variantId === vId);
    if (ex) ex.qty++; else cart.push({...item, qty: 1});
    item.stock--;
    updateCart();
    renderProducts(items);
}

function updateCart() {
    const cb = document.getElementById('cartBody');
    cb.innerHTML = '';
    cart.forEach((i, idx) => {
        const r = document.createElement('tr');
        r.innerHTML = `<td>${i.name}</td><td>${i.qty}</td><td>${(i.price*i.qty).toFixed(2)}</td>
        <td><button onclick="removeItem(${idx})" style="background:none; color:red; border:none;">‚úï</button></td>`;
        cb.appendChild(r);
    });
    const total = cart.reduce((s, i) => s + (i.price * i.qty), 0);
    document.getElementById('totalLabel').textContent = `${total.toFixed(2)} BOB`;
    updateChange();
}

function removeItem(idx) {
    const original = items.find(x => x.variantId === cart[idx].variantId);
    if (original) original.stock += cart[idx].qty;
    cart.splice(idx, 1);
    updateCart();
    renderProducts(items);
}

function updateChange() {
    const pay = parseFloat(document.getElementById('paymentAmount').value) || 0;
    const total = cart.reduce((s, i) => s + (i.price * i.qty), 0);
    const msg = document.getElementById('changeMessage');
    if (pay <= 0) msg.innerHTML = '';
    else if (pay < total) msg.innerHTML = `<span class="error">Falta: ${(total-pay).toFixed(2)}</span>`;
    else msg.innerHTML = `<span class="success">Cambio: ${(pay-total).toFixed(2)}</span>`;
}

function filterItems() {
    const q = document.getElementById('searchInput').value.toLowerCase();
    renderProducts(items.filter(i => i.name.toLowerCase().includes(q) || i.category.toLowerCase().includes(q) || i.barcode.includes(q)));
}

/* --- VENTA E IMPRESI√ìN --- */
async function registerSale() {
    if (!cart.length) return alert('Carrito vac√≠o');
    const total = cart.reduce((s, i) => s + (i.price * i.qty), 0);
    
    document.getElementById('statusMessage').innerHTML = '‚è≥ Registrando en Loyverse...';

    try {
        const res = await fetch(workerUrl + '/v1.0/receipts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                receipt_type: 'SALE',
                line_items: cart.map(i => ({ variant_id: i.variantId, quantity: i.qty })),
                payments: [{ payment_type_id: '080f1ca3-0aea-410b-9d27-801e6c7a6c58', amount: total }]
            })
        });

        if (res.ok) {
            if (confirm('‚úÖ Venta registrada con √©xito. ¬øDesea imprimir el ticket?')) {
                printTicket();
            }
            cart = [];
            updateCart();
            loadItems(); // Recarga stock real
        } else {
            alert('Error al registrar la venta.');
        }
    } catch (e) { alert('Error de conexi√≥n con el servidor.'); }
}

function printTicket() {
    const win = window.open('', '', 'width=300');
    const total = cart.reduce((s, i) => s + (i.price * i.qty), 0);
    const fecha = new Date().toLocaleString();

    win.document.write(`
        <html><body style="font-family:monospace; width:100%; font-size:12px;">
            <div style="text-align:center;">
                <h3>MI TIENDA</h3>
                <p>${fecha}</p>
                <hr>
            </div>
            <table style="width:100%; font-size:12px;">
                ${cart.map(i => `
                    <tr>
                        <td colspan="2">${i.name}</td>
                    </tr>
                    <tr>
                        <td>${i.qty} x ${i.price.toFixed(2)}</td>
                        <td style="text-align:right;">${(i.qty*i.price).toFixed(2)}</td>
                    </tr>
                `).join('')}
            </table>
            <hr>
            <div style="text-align:right; font-size:14px;">
                <b>TOTAL: ${total.toFixed(2)} BOB</b>
            </div>
            <div style="text-align:center; margin-top:20px;">
                <p>¬°Gracias por su compra!</p>
            </div>
            <script>window.onload = function() { window.print(); window.close(); }</script>
        </body></html>
    `);
    win.document.close();
}

function clearCart() {
    cart.forEach(c => { const o = items.find(x => x.variantId === c.variantId); if(o) o.stock += c.qty; });
    cart = []; updateCart(); renderProducts(items);
}

document.getElementById('barcodeInput').addEventListener('keydown', e => {
    if (e.key === 'Enter') {
        const i = items.find(x => x.barcode === e.target.value.trim());
        if (i) addToCartByVId(i.variantId);
        e.target.value = '';
    }
});

loadItems();
</script>
</body>
</html>
