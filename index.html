<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>POS Loyverse</title>

<style>
body { font-family: Arial, sans-serif; background:#f9f9f9; padding:20px; }
h1 { text-align:center; }
.container { display:flex; gap:20px; max-width:1400px; margin:auto; }

.products { flex:3; }
.cart {
    flex:1; background:#fff; padding:20px; border-radius:8px;
    box-shadow:0 2px 10px rgba(0,0,0,.1);
    position:sticky; top:20px; align-self:flex-start;
    max-height:calc(100vh - 40px); overflow-y:auto;
}

input, button { width:100%; padding:10px; margin:6px 0; font-size:16px; }
button { background:#4CAF50; color:#fff; border:none; cursor:pointer; }
button:hover { background:#45a049; }

table { width:100%; border-collapse:collapse; background:#fff; margin-top:10px; }
th, td { border:1px solid #ddd; padding:8px; }
th { background:#f2f2f2; }

.total { font-size:1.4em; font-weight:bold; color:#d32f2f; text-align:right; }
.error { color:red; font-weight:bold; }
.success { color:green; font-weight:bold; }

@media(max-width:900px){
  .container{flex-direction:column;}
  .cart{position:static; max-height:none;}
}
</style>
</head>

<body>

<h1>Tienda</h1>

<div id="statusMessage" style="text-align:center"></div>

<div class="container">

<div class="products">
<h2>Productos</h2>
<input id="barcodeInput" placeholder="Escanear c√≥digo..." autofocus>
<input id="searchInput" placeholder="Buscar..." oninput="filterItems()">

<table>
<thead>
<tr>
    <th>Nombre</th>
    <th>Categor√≠a</th>
    <th>Barcode</th>
    <th>Stock</th>
    <th>Precio</th>
    <th></th>
</tr>
</thead>

<tbody id="productsBody"></tbody>
</table>
</div>

<div class="cart">
<h2>Carrito</h2>

<table>
<thead><tr><th>Producto</th><th>Cant</th><th>Sub</th><th></th></tr></thead>
<tbody id="cartBody"></tbody>
</table>

<div class="total" id="totalLabel">Total: 0.00 BOB</div>

<label>Monto Pagado</label>
<input type="number" id="paymentAmount" step="0.01" oninput="updateChange()">

<button onclick="registerSale()">Registrar Venta</button>

<p id="changeMessage"></p>

<button style="background:#f44336" onclick="clearCart()">Limpiar</button>
</div>
</div>

<audio id="beep">
  <source src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg">
</audio>

<script>
const workerUrl = 'https://loyverse-proxy-erik.erikrojas76.workers.dev';

let items = [];
let cart = [];

/* ===================== */
function getTotal(){ return cart.reduce((s,i)=>s+i.price*i.qty,0); }

    
/* ===================== */
async function loadInventory() {
    let inventory = {};
    let url = '/v1.0/inventory?limit=250';

    while (url) {
        const res = await fetch(workerUrl + url);
        const data = await res.json();

        (data.inventory || []).forEach(i => {
            inventory[i.variant_id] = i.in_stock;
        });

        url = data.cursor ? `/v1.0/inventory?limit=250&cursor=${data.cursor}` : null;
    }

    return inventory;
}
    
/* ===================== */
    
async function loadItems() {
    const status = document.getElementById('statusMessage');
    status.textContent = 'Cargando productos...';

    items = [];

    const inventory = await loadInventory(); // üëà STOCK REAL

    let url = '/v1.0/items?limit=250';

    while (url) {
        const res = await fetch(workerUrl + url);
        const data = await res.json();

        (data.items || []).forEach(item => {
            item.variants.forEach(variant => {
                variant.stores.forEach(store => {
                    if (store.available_for_sale) {
                        items.push({
                            name: item.item_name,
                            category: item.category_name || '-',
                            barcode: variant.barcode || '',
                            sku: variant.sku || '',
                            variantId: variant.variant_id,
                            price: store.price,
                            stock: inventory[variant.variant_id] ?? 0
                        });
                    }
                });
            });
        });

        url = data.cursor ? `/v1.0/items?limit=250&cursor=${data.cursor}` : null;
    }

    renderProducts(items);
    status.innerHTML = `<span class="success">Productos cargados</span>`;
}


/* ===================== */
function renderProducts(list){
    const tb = productsBody;
    tb.innerHTML = '';

    list.forEach(i => {
        const r = document.createElement('tr');
        r.innerHTML = `
            <td>${i.name}</td>
            <td>${i.category}</td>
            <td>${i.barcode || '-'}</td>
            <td>${i.stock}</td>
            <td>${i.price.toFixed(2)}</td>
            <td>
                <button ${i.stock <= 0 ? 'disabled' : ''}>+</button>
            </td>
        `;
        r.querySelector('button').onclick = () => addToCart(i);
        tb.appendChild(r);
    });
}


/* ===================== */
function addToCart(item){
  if(item.stock<=0){ alert('Sin stock'); return; }

  document.getElementById('beep').play();

  const e=cart.find(i=>i.variantId===item.variantId);
  e?e.qty++:cart.push({...item,qty:1});
  item.stock--;
  updateCart();
  renderProducts(items);
}

function updateCart(){
  cartBody.innerHTML='';
  cart.forEach((i,idx)=>{
    const r=document.createElement('tr');
    r.innerHTML=`
      <td>${i.name}</td>
      <td>${(i.price*i.qty).toFixed(2)}</td>
      <td><button onclick="removeItem(${idx})">X</button></td>`;
    cartBody.appendChild(r);
  });
  totalLabel.textContent=`Total: ${getTotal().toFixed(2)} BOB`;
  updateChange();
}

function removeItem(i){
  items.find(x=>x.variantId===cart[i].variantId).stock+=cart[i].qty;
  cart.splice(i,1);
  updateCart(); renderProducts(items);
}

function clearCart(){
  cart.forEach(i=>{
    items.find(x=>x.variantId===i.variantId).stock+=i.qty;
  });
  cart=[];
  updateCart();
  paymentAmount.value='';
  changeMessage.textContent='';
}

/* ===================== */
function updateChange(){
  const pay=parseFloat(paymentAmount.value)||0;
  const total=getTotal();
  if(!pay){ changeMessage.textContent=''; return; }
  changeMessage.innerHTML =
    pay<total
      ? `<span class="error">Faltan ${(total-pay).toFixed(2)}</span>`
      : `<span class="success">Cambio ${(pay-total).toFixed(2)}</span>`;
}

/* ===================== */
barcodeInput.addEventListener('keydown',e=>{
  if(e.key==='Enter'){
    const code=barcodeInput.value.trim();
    const item=items.find(i=>i.barcode===code);
    if(item) addToCart(item);
    barcodeInput.value='';
  }
});

/* ===================== */
async function registerSale(){
  if(!cart.length) return alert('Carrito vac√≠o');

  await fetch(workerUrl+'/v1.0/receipts',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      receipt_type:'SALE',
      line_items:cart.map(i=>({
        variant_id:i.variantId,
        quantity:i.qty,
        price:i.price
      })),
      payments:[{amount:getTotal(),payment_type_id:'080f1ca3-0aea-410b-9d27-801e6c7a6c58'}]
    })
  });

  printTicket();
  clearCart();
}

/* ===================== */
function printTicket(){
  const win=window.open('','','width=300');
  win.document.write(`<h3>TICKET</h3>`);
  cart.forEach(i=>{
    win.document.write(`${i.qty} x ${i.name} ${i.price.toFixed(2)}<br>`);
  });
  win.document.write(`<b>Total: ${getTotal().toFixed(2)}</b>`);
  win.print();
  win.close();
}
</script>

</body>
</html>
