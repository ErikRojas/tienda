<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS Loyverse Pro</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background:#f4f7f6; padding:20px; color: #333; margin:0; }
        .container { display:flex; gap:20px; max-width:1400px; margin:auto; }
        .products { flex:3; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .cart { flex:1; background:#fff; padding:20px; border-radius:8px; box-shadow:0 4px 15px rgba(0,0,0,.1); position:sticky; top:20px; height: fit-content; }
        input { width:100%; padding:12px; margin:8px 0; border:2px solid #ddd; border-radius:4px; box-sizing: border-box; font-size: 16px; }
        input:focus { border-color: #3498db; outline: none; }
        button { width:100%; padding:12px; margin:6px 0; font-size:16px; border:none; border-radius:4px; cursor:pointer; font-weight: bold; }
        .btn-add { background:#4CAF50; color:#fff; }
        table { width:100%; border-collapse:collapse; }
        th, td { border-bottom:1px solid #eee; padding:10px; text-align: left; }
        th { background:#f8f9fa; font-size: 11px; color: #888; text-transform: uppercase; }
        .total { font-size:1.8em; font-weight:bold; color:#d32f2f; text-align:right; margin: 15px 0; }
        .status-bar { background: #2c3e50; color: white; padding: 10px; text-align: center; margin-bottom: 20px; border-radius: 4px; font-weight: bold; }
        #barcodeInput { background: #e8f4fd; border-color: #3498db; }
        .change-box { padding: 10px; border-radius: 4px; font-weight: bold; margin-bottom: 10px; text-align: center; }
        .insufficient { background: #ffebee; color: #c62828; }
        .sufficient { background: #e8f5e9; color: #2e7d32; }
    </style>
</head>
<body>

<div id="statusMessage" class="status-bar">Inicializando sistema...</div>

<div class="container">
    <div class="products">
        <div style="display:flex; justify-content: space-between; align-items: center;">
            <h2>Inventario Completo</h2>
            <button onclick="loadAllData()" style="width:auto; font-size:12px; padding:5px 15px; background:#3498db; color:white;">ðŸ”„ Sincronizar Todo</button>
        </div>
        
        <input id="barcodeInput" placeholder="MODO ESCÃNER: Listo para leer..." autofocus>
        <input id="searchInput" placeholder="Buscador manual (nombre, categorÃ­a, cÃ³digo)..." oninput="filterItems()">
        
        <table>
            <thead>
                <tr>
                    <th>Producto</th>
                    <th>CategorÃ­a</th>
                    <th>CÃ³digo/SKU</th>
                    <th>Stock</th>
                    <th>Precio</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="productsBody"></tbody>
        </table>
    </div>

    <div class="cart">
        <h2>Carrito</h2>
        <table id="cartTable">
            <thead><tr><th>Item</th><th>Cant</th><th>Sub</th><th></th></tr></thead>
            <tbody id="cartBody"></tbody>
        </table>
        
        <div class="total" id="totalLabel">0.00 BOB</div>

        <div id="paymentSection">
            <label><b>Monto Recibido:</b></label>
            <input type="number" id="paymentAmount" step="0.10" placeholder="0.00" oninput="calculateChange()">
            <div id="changeDisplay" class="change-box" style="display:none;"></div>
        </div>

        <button onclick="registerSale()" style="background: #27ae60; color: white;">FINALIZAR VENTA</button>
        <button onclick="clearCart()" style="background:#e74c3c; color: white; font-size: 11px;">VACIAR CARRITO</button>
    </div>
</div>

<audio id="beep"><source src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>

<script>
const workerUrl = 'https://loyverse-proxy-erik.erikrojas76.workers.dev';
let items = [];
let cart = [];

// PAGINACIÃ“N AUTOMÃTICA
async function fetchAll(endpoint, key) {
    let results = [];
    let cursor = '';
    let hasMore = true;
    while (hasMore) {
        try {
            const url = `${workerUrl}${endpoint}${endpoint.includes('?') ? '&' : '?'}limit=250${cursor ? '&cursor=' + cursor : ''}`;
            const res = await fetch(url);
            const data = await res.json();
            if (data[key]) results = results.concat(data[key]);
            cursor = data.cursor || '';
            hasMore = !!cursor;
        } catch (e) {
            console.error("Error paginando:", e);
            hasMore = false;
        }
    }
    return results;
}

async function loadAllData() {
    const status = document.getElementById('statusMessage');
    status.innerHTML = 'ðŸ”„ Cargando artÃ­culos y stock...';
    try {
        const [invRaw, catRaw, itemsRaw] = await Promise.all([
            fetchAll('/v1.0/inventory', 'inventory_levels'),
            fetchAll('/v1.0/categories', 'categories'),
            fetchAll('/v1.0/items', 'items')
        ]);

        const invMap = {};
        invRaw.forEach(i => invMap[i.variant_id] = (invMap[i.variant_id] || 0) + (i.in_stock || 0));
        const catMap = {};
        catRaw.forEach(c => catMap[c.id] = c.name);

        items = [];
        itemsRaw.forEach(item => {
            item.variants.forEach(v => {
                v.stores.forEach(s => {
                    if (s.available_for_sale) {
                        items.push({
                            name: v.variant_name !== 'Default' ? `${item.item_name} (${v.variant_name})` : item.item_name,
                            category: catMap[item.category_id] || 'General',
                            barcode: (v.barcode || v.sku || "").trim(),
                            variantId: v.variant_id,
                            price: s.price || 0,
                            stock: invMap[v.variant_id] !== undefined ? invMap[v.variant_id] : '-'
                        });
                    }
                });
            });
        });

        renderProducts(items);
        status.innerHTML = `âœ… ${items.length} productos sincronizados.`;
        document.getElementById('barcodeInput').focus();
    } catch (e) {
        status.innerHTML = 'âŒ Error de conexiÃ³n.';
    }
}

function renderProducts(list) {
    const tb = document.getElementById('productsBody');
    tb.innerHTML = '';
    list.forEach(i => {
        const r = document.createElement('tr');
        r.innerHTML = `
            <td>${i.name}</td>
            <td>${i.category}</td>
            <td><small>${i.barcode}</small></td>
            <td><b>${i.stock}</b></td>
            <td>${i.price.toFixed(2)}</td>
            <td><button class="btn-add" onclick="addToCartByVId('${i.variantId}')">+</button></td>
        `;
        tb.appendChild(r);
    });
}

function addToCartByVId(vId) {
    const item = items.find(x => x.variantId === vId);
    if (!item) return;
    document.getElementById('beep').play();
    const ex = cart.find(c => c.variantId === vId);
    if (ex) ex.qty++; else cart.push({...item, qty: 1});
    updateCart();
}

function updateCart() {
    const cb = document.getElementById('cartBody');
    cb.innerHTML = '';
    let total = 0;
    cart.forEach((i, idx) => {
        const sub = i.price * i.qty;
        total += sub;
        cb.innerHTML += `<tr><td>${i.name}</td><td>${i.qty}</td><td>${sub.toFixed(2)}</td><td><button onclick="removeItem(${idx})" style="background:none;color:red;font-weight:bold;">âœ•</button></td></tr>`;
    });
    document.getElementById('totalLabel').textContent = total.toFixed(2) + ' BOB';
    calculateChange();
}

function removeItem(idx) {
    cart.splice(idx, 1);
    updateCart();
}

function calculateChange() {
    const total = cart.reduce((s, i) => s + (i.price * i.qty), 0);
    const pay = parseFloat(document.getElementById('paymentAmount').value) || 0;
    const display = document.getElementById('changeDisplay');
    
    if (pay <= 0) {
        display.style.display = 'none';
        return;
    }
    
    display.style.display = 'block';
    const diff = pay - total;
    if (diff < 0) {
        display.className = 'change-box insufficient';
        display.textContent = 'Falta: ' + Math.abs(diff).toFixed(2) + ' BOB';
    } else {
        display.className = 'change-box sufficient';
        display.textContent = 'Cambio: ' + diff.toFixed(2) + ' BOB';
    }
}

function filterItems() {
    const q = document.getElementById('searchInput').value.toLowerCase();
    renderProducts(items.filter(i => 
        i.name.toLowerCase().includes(q) || 
        i.category.toLowerCase().includes(q) || 
        i.barcode.toLowerCase().includes(q)
    ));
}

// ESCÃNER
document.getElementById('barcodeInput').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        const code = this.value.trim();
        if(!code) return;
        const found = items.find(i => i.barcode === code);
        if (found) {
            addToCartByVId(found.variantId);
            this.value = '';
        } else {
            alert("No encontrado: " + code);
            this.value = '';
        }
        this.focus();
    }
});

// VENTA E IMPRESIÃ“N
async function registerSale() {
    if (!cart.length) return alert('Carrito vacÃ­o');
    const total = cart.reduce((s, i) => s + (i.price * i.qty), 0);
    const pay = parseFloat(document.getElementById('paymentAmount').value) || 0;

    if (pay < total && pay > 0) {
        if(!confirm('El monto recibido es menor al total. Â¿Continuar?')) return;
    }

    document.getElementById('statusMessage').innerHTML = 'â³ Registrando en Loyverse...';

    try {
        const res = await fetch(workerUrl + '/v1.0/receipts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                receipt_type: 'SALE',
                line_items: cart.map(i => ({ variant_id: i.variantId, quantity: i.qty })),
                payments: [{ payment_type_id: '080f1ca3-0aea-410b-9d27-801e6c7a6c58', amount: total }]
            })
        });

        if (res.ok) {
            const finalCart = [...cart]; // Copia para el ticket
            const finalTotal = total;
            
            if (confirm('âœ… Venta registrada con Ã©xito. Â¿Desea imprimir el ticket?')) {
                printTicket(finalCart, finalTotal);
            }
            
            cart = [];
            document.getElementById('paymentAmount').value = '';
            updateCart();
            loadAllData();
        } else {
            alert('Error al registrar la venta.');
        }
    } catch (e) { alert('Error de red.'); }
}

function printTicket(data, total) {
    const win = window.open('', '', 'width=300');
    const fecha = new Date().toLocaleString();
    let h = '<html><body style="font-family:monospace;padding:10px;font-size:12px;">';
    h += '<div style="text-align:center;"><h3>RECIBO DE VENTA</h3><p>'+fecha+'</p></div><hr>';
    data.forEach(i => {
        h += '<p>' + i.name + '<br>' + i.qty + ' x ' + i.price.toFixed(2) + ' = ' + (i.qty*i.price).toFixed(2) + '</p>';
    });
    h += '<hr><h3 style="text-align:right">TOTAL: ' + total.toFixed(2) + ' BOB</h3>';
    h += '<p style="text-align:center;margin-top:20px;">Â¡Gracias por su compra!</p>';
    h += '<script>window.onload=function(){window.print();window.close();}<\/script></body></html>';
    win.document.write(h);
    win.document.close();
}

function clearCart() {
    if(confirm('Â¿Vaciar el carrito?')) { cart = []; updateCart(); }
}

loadAllData();
</script>
</body>
</html>
